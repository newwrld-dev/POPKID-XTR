import moment from 'moment-timezone';
import fs from 'fs';
import os from 'os';
import pkg from '@whiskeysockets/baileys';
const { generateWAMessageFromContent, proto } = pkg;
import config from '../config.cjs';
import axios from 'axios';

// Memory Calculations
const totalMemoryBytes = os.totalmem();
const freeMemoryBytes = os.freemem();
const byteToMB = 1 / (1024 * 1024);

function formatBytes(bytes) {
  return (bytes * byteToMB).toFixed(2) + ' MB';
}

const menu = async (m, Matrix) => {
  const prefix = config.PREFIX;
  const cmd = m.body.startsWith(prefix) ? m.body.slice(prefix.length).split(' ')[0].toLowerCase() : '';
  const mode = config.MODE === 'public' ? '·¥ò·¥ú ô ü…™·¥Ñ' : '·¥ò Ä…™·¥†·¥Ä·¥õ·¥á';

  // Real-time Uptime
  const uptime = process.uptime();
  const day = Math.floor(uptime / (24 * 3600)); 
  const hours = Math.floor((uptime % (24 * 3600)) / 3600); 
  const minutes = Math.floor((uptime % 3600) / 60); 

  // Dynamic Greeting
  const time2 = moment().tz("Asia/Colombo").format("HH:mm:ss");
  let pushwish = "…¢·¥è·¥è·¥Ö …¥…™…¢ ú·¥õ üåå";
  if (time2 < "12:00:00") pushwish = `…¢·¥è·¥è·¥Ö ·¥ç·¥è Ä…¥…™…¥…¢ üåÑ`;
  else if (time2 < "17:00:00") pushwish = `…¢·¥è·¥è·¥Ö ·¥ÄÍú∞·¥õ·¥á Ä…¥·¥è·¥è…¥ üåÖ`;
  else if (time2 < "20:00:00") pushwish = `…¢·¥è·¥è·¥Ö ·¥á·¥†·¥á…¥…™…¥…¢ üåÉ`;

  const validCommands = ['list', 'help', 'menu', 'allmenu'];

  if (validCommands.includes(cmd)) {
    const readMore = String.fromCharCode(8206).repeat(4001);
    const mainMenu = `
‚ïî‚ïê‚ïê‚ïê üì• ·¥ò·¥è·¥ò·¥ã…™·¥Ö x·¥ç·¥Ö ·¥†3 üì• ‚ïê‚ïê‚ïê‚ïó
‚ïë üë§ ·¥è·¥°…¥·¥á Ä: ${config.OWNER_NAME}
‚ïë ü§ñ  ô·¥è·¥õ: ${config.BOT_NAME}
‚ïë ‚öôÔ∏è ·¥ç·¥è·¥Ö·¥á: ${mode}
‚ïë ‚è≥ ·¥ú·¥ò·¥õ…™·¥ç·¥á: ${day}·¥Ö ${hours} ú ${minutes}·¥ç
‚ïë üìü ·¥ò ü·¥Ä·¥õÍú∞·¥è Ä·¥ç: ${os.platform()}
‚ïë üöÄ  Ä·¥Ä·¥ç: ${formatBytes(freeMemoryBytes)}
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

${pushwish} *${m.pushName}*!
${readMore}
‚îè‚îÅ‚îÅ„Äî ·¥Ö·¥è·¥°…¥ ü·¥è·¥Ä·¥Ö·¥á Ä „Äï‚îÅ‚îà‚ä∑
‚îÉ üì• ·¥Ä·¥ò·¥ã
‚îÉ üì• Íú∞·¥Ä·¥Ñ·¥á ô·¥è·¥è·¥ã
‚îÉ üì• …™…¥s·¥õ·¥Ä…¢ Ä·¥Ä·¥ç
‚îÉ üì• ·¥õ…™·¥ã·¥õ·¥è·¥ã
‚îÉ üì• ·¥ç·¥á·¥Ö…™·¥ÄÍú∞…™ Ä·¥á
‚îÉ üì• …¢·¥Ö Ä…™·¥†·¥á
‚îÉ üì• ·¥ò…™…¥·¥õ·¥á Ä·¥ás·¥õ·¥Ö ü
‚îÉ üì• …¢…™·¥õ·¥Ñ ü·¥è…¥·¥á
‚îÉ üì• ·¥ò ü·¥Ä è
‚îÉ üì• s·¥è…¥…¢
‚îÉ üì• ·¥†…™·¥Ö·¥á·¥è
‚îÉ üì•  è·¥õs
‚îÉ üì•  è·¥õ·¥ç·¥ò3
‚îÉ üì•  è·¥õ·¥ç·¥ò4
‚îÉ üì•  è·¥õ·¥ç·¥ò3·¥Ö·¥è·¥Ñ
‚îÉ üì•  è·¥õ·¥ç·¥ò4·¥Ö·¥è·¥Ñ
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥Ä…™ ·¥Ñ ú·¥Ä·¥õ „Äï‚îÅ‚îà‚ä∑
‚îÉ ü§ñ ·¥Ä…™
‚îÉ ü§ñ …¢·¥ò·¥õ
‚îÉ ü§ñ …¢·¥á·¥ç…™…¥…™
‚îÉ ü§ñ  ô·¥è·¥õ
‚îÉ ü§ñ ·¥Ñ ú·¥Ä·¥õ ô·¥è·¥õ
‚îÉ ü§ñ  ü è·¥Ö·¥á·¥Ä
‚îÉ ü§ñ ·¥Ö·¥Ä ü ü·¥á
‚îÉ ü§ñ  Ä·¥á·¥ç…™…¥…™
‚îÉ ü§ñ …™·¥ç·¥Ä…¢…™…¥·¥á
‚îÉ ü§ñ ·¥ú·¥òs·¥Ñ·¥Ä ü·¥á
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî …¢ Ä·¥è·¥ú·¥ò „Äï‚îÅ‚îà‚ä∑
‚îÉ üë•  ü…™…¥·¥ã…¢ Ä·¥è·¥ú·¥ò
‚îÉ üë• s·¥á·¥õ·¥ò·¥ò…¢·¥Ñ
‚îÉ üë• s·¥á·¥õ…¥·¥Ä·¥ç·¥á
‚îÉ üë• s·¥á·¥õ·¥Ö·¥ás·¥Ñ
‚îÉ üë• …¢ Ä·¥è·¥ú·¥ò
‚îÉ üë• ·¥°·¥á ü·¥Ñ·¥è·¥ç·¥á
‚îÉ üë• ·¥Ä·¥Ö·¥Ö
‚îÉ üë• ·¥ã…™·¥Ñ·¥ã
‚îÉ üë•  ú…™·¥Ö·¥á·¥õ·¥Ä…¢
‚îÉ üë• ·¥õ·¥Ä…¢·¥Ä ü ü
‚îÉ üë• ·¥õ·¥Ä…¢·¥Ä·¥Ö·¥ç…™…¥
‚îÉ üë• ·¥Ä…¥·¥õ…™ ü…™…¥·¥ã
‚îÉ üë• ·¥Ä…¥·¥õ…™ ô·¥è·¥õ
‚îÉ üë• ·¥Ä…¥·¥õ…™·¥Ö·¥á ü·¥á·¥õ·¥á
‚îÉ üë• ·¥ò Ä·¥è·¥ç·¥è·¥õ·¥á
‚îÉ üë• ·¥Ö·¥á·¥ç·¥è·¥õ·¥á
‚îÉ üë• …¢·¥á·¥õ ô…™·¥è
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî s·¥á·¥Ä Ä·¥Ñ ú „Äï‚îÅ‚îà‚ä∑
‚îÉ üîç …¢·¥è·¥è…¢ ü·¥á
‚îÉ üîç …¢…™·¥ç·¥Ä…¢·¥á
‚îÉ üîç ·¥ò…™…¥·¥õ·¥á Ä·¥ás·¥õ
‚îÉ üîç ·¥°·¥Ä ü ü·¥ò·¥Ä·¥ò·¥á Ä
‚îÉ üîç ·¥°…™·¥ã…™·¥ç·¥á·¥Ö…™·¥Ä
‚îÉ üîç  è·¥õs·¥á·¥Ä Ä·¥Ñ ú
‚îÉ üîç  ü è Ä…™·¥Ñs
‚îÉ üîç …™·¥ç·¥Ö ô
‚îÉ üîç  Ä…™…¥…¢·¥õ·¥è…¥·¥á
‚îÉ üîç ·¥°·¥á·¥Ä·¥õ ú·¥á Ä
‚îÉ üîç …¥·¥á·¥°s
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥Ñ·¥è…¥·¥†·¥á Ä·¥õ·¥á Ä „Äï‚îÅ‚îà‚ä∑
‚îÉ üîÑ ·¥Ä·¥õ·¥õ·¥ò
‚îÉ üîÑ ·¥Ä·¥õ·¥õ·¥ò2
‚îÉ üîÑ s·¥õ…™·¥Ñ·¥ã·¥á Ä
‚îÉ üîÑ ·¥á ô…™…¥·¥Ä Ä è
‚îÉ üîÑ ·¥Ö ô…™…¥·¥Ä Ä è
‚îÉ üîÑ ·¥õ·¥è·¥ú Ä ü
‚îÉ üîÑ ·¥á·¥ç·¥è·¥ä…™·¥ç…™x
‚îÉ üîÑ ·¥ç·¥ò3
‚îÉ üîÑ ·¥õ·¥è·¥Ä·¥ú·¥Ö…™·¥è
‚îÉ üîÑ ·¥õ·¥è…™·¥ç…¢
‚îÉ üîÑ  ô ü·¥ú Ä Ä·¥á·¥Ö
‚îÉ üîÑ ·¥Ñ…™ Ä·¥Ñ ü·¥á
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥á·¥Ñ·¥è…¥·¥è·¥ç è „Äï‚îÅ‚îà‚ä∑
‚îÉ üí∞  ô·¥Ä ü·¥Ä…¥·¥Ñ·¥á
‚îÉ üí∞ ·¥Ö·¥Ä…™ ü è
‚îÉ üí∞ ·¥á·¥Ä Ä…¥
‚îÉ üí∞ ·¥Ö·¥á·¥ò·¥ès…™·¥õ
‚îÉ üí∞ ·¥°…™·¥õ ú·¥Ö Ä·¥Ä·¥°
‚îÉ üí∞ ·¥õ Ä·¥Ä…¥sÍú∞·¥á Ä
‚îÉ üí∞  ü·¥á·¥Ä·¥Ö·¥á Ä ô·¥è·¥Ä Ä·¥Ö
‚îÉ üí∞ ·¥°·¥Ä ü ü·¥á·¥õ
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥Ä…¥…™·¥ç·¥á & …¥sÍú∞·¥° „Äï‚îÅ‚îà‚ä∑
‚îÉ üîû ·¥°·¥Ä…™Íú∞·¥ú
‚îÉ üîû …¥·¥á·¥ã·¥è
‚îÉ üîû s ú…™…¥·¥è ô·¥ú
‚îÉ üîû ·¥ç·¥á…¢·¥ú·¥ç…™…¥
‚îÉ üîû ·¥Ñ·¥ès·¥ò ü·¥Ä è
‚îÉ üîû  ú·¥ús ô·¥ú
‚îÉ üîû  ô ü·¥è·¥°·¥ä·¥è ô
‚îÉ üîû ·¥ò·¥úss è
‚îÉ üîû ·¥ç…™ üÍú∞
‚îÉ üîû  è·¥ú Ä…™
‚îÉ üîû  ú·¥á…¥·¥õ·¥Ä…™
‚îÉ üîû ·¥õ Ä·¥Ä·¥ò
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî s·¥õ·¥Ä ü·¥ã·¥á Ä „Äï‚îÅ‚îà‚ä∑
‚îÉ üïµÔ∏è ·¥õ Ä·¥ú·¥á·¥Ñ·¥Ä ü ü·¥á Ä
‚îÉ üïµÔ∏è …™…¥s·¥õ·¥Äs·¥õ·¥Ä ü·¥ã
‚îÉ üïµÔ∏è …¢…™·¥õ ú·¥ú ôs·¥õ·¥Ä ü·¥ã
‚îÉ üïµÔ∏è ·¥õ…™·¥ã·¥õ·¥è·¥ãs·¥õ·¥Ä ü·¥ã
‚îÉ üïµÔ∏è …¥·¥ò·¥çs·¥õ·¥Ä ü·¥ã
‚îÉ üïµÔ∏è ·¥õ·¥°…™·¥õ·¥õ·¥á Äs·¥õ·¥Ä ü·¥ã
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥õ·¥è·¥è üs „Äï‚îÅ‚îà‚ä∑
‚îÉ üõ†Ô∏è ·¥Ñ·¥Ä ü·¥Ñ·¥ú ü·¥Ä·¥õ·¥è Ä
‚îÉ üõ†Ô∏è ·¥õ·¥á·¥ç·¥ò·¥ç·¥Ä…™ ü
‚îÉ üõ†Ô∏è ·¥Ñ ú·¥á·¥Ñ·¥ã·¥ç·¥Ä…™ ü
‚îÉ üõ†Ô∏è ·¥õ Ä·¥õ
‚îÉ üõ†Ô∏è ·¥õ·¥õs
‚îÉ üõ†Ô∏è ss
‚îÉ üõ†Ô∏è «´ Ä
‚îÉ üõ†Ô∏è  Ä·¥á·¥Ä·¥Ö«´ Ä
‚îÉ üõ†Ô∏è ·¥ò Ä·¥èÍú∞…™ ü·¥á
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥è·¥°…¥·¥á Ä „Äï‚îÅ‚îà‚ä∑
‚îÉ üëë ·¥ä·¥è…™…¥
‚îÉ üëë  ü·¥á·¥Ä·¥†·¥á
‚îÉ üëë  ô ü·¥è·¥Ñ·¥ã
‚îÉ üëë ·¥ú…¥ ô ü·¥è·¥Ñ·¥ã
‚îÉ üëë s·¥á·¥õ·¥ò·¥ò ô·¥è·¥õ
‚îÉ üëë ·¥Ä…¥·¥õ…™·¥Ñ·¥Ä ü ü
‚îÉ üëë s·¥á·¥õs·¥õ·¥Ä·¥õ·¥ús
‚îÉ üëë ·¥Ä·¥ú·¥õ·¥è·¥õ è·¥ò…™…¥…¢
‚îÉ üëë ·¥Ä·¥ú·¥õ·¥è Ä·¥á·¥Ä·¥Ö
‚îÉ üëë ·¥Ä·¥Ö·¥Ö·¥ò Ä·¥á·¥ç…™·¥ú·¥ç
‚îÉ üëë ·¥ä…™·¥Ö
‚îÉ üëë  Ä·¥ás·¥õ·¥Ä Ä·¥õ
‚îÉ üëë ·¥ú·¥ò·¥Ö·¥Ä·¥õ·¥á
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

‚îè‚îÅ‚îÅ„Äî ·¥ç·¥Ä…™…¥ „Äï‚îÅ‚îà‚ä∑
‚îÉ ‚ö° ·¥ò…™…¥…¢
‚îÉ ‚ö° ·¥Ä ü…™·¥†·¥á
‚îÉ ‚ö° ·¥è·¥°…¥·¥á Ä
‚îÉ ‚ö° ·¥ç·¥á…¥·¥ú
‚îÉ ‚ö° …™…¥Íú∞·¥è ô·¥è·¥õ
‚îÉ ‚ö° ·¥ú·¥ò·¥õ…™·¥ç·¥á
‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îà‚ä∑

> ·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è ·¥ò·¥è·¥ò·¥ã…™·¥Ö x·¥ç·¥Ö ·¥†3
`;

    const getMenuImage = async () => {
      if (config.MENU_IMAGE && config.MENU_IMAGE.trim() !== '') {
        try {
          const response = await axios.get(config.MENU_IMAGE, { responseType: 'arraybuffer' });
          return Buffer.from(response.data, 'binary');
        } catch (error) {
          return fs.readFileSync('./media/zenor.jpeg');
        }
      } else {
        return fs.readFileSync('./media/zenor.jpeg');
      }
    };

    const menuImage = await getMenuImage();

    await Matrix.sendMessage(m.from, {
      image: menuImage,
      caption: mainMenu,
      contextInfo: {
        mentionedJid: [m.sender],
        forwardingScore: 999,
        isForwarded: true,
        forwardedNewsletterMessageInfo: {
          newsletterJid: '120363289379419860@newsletter',
          newsletterName: "·¥ò·¥è·¥ò·¥ã…™·¥Ö ·¥ú·¥ò·¥Ö·¥Ä·¥õ·¥ás",
          serverMessageId: 143
        },
        externalAdReply: {
            title: "·¥ò·¥è·¥ò·¥ã…™·¥Ö x·¥ç·¥Ö ·¥èÍú∞Íú∞…™·¥Ñ…™·¥Ä ü",
            body: "s·¥õ è ü…™s ú ·¥° ú·¥Ä·¥õs·¥Ä·¥ò·¥ò ·¥áx·¥ò·¥á Ä…™·¥á…¥·¥Ñ·¥á",
            thumbnailUrl: "https://files.catbox.moe/yr339d.jpg",
            sourceUrl: "https://whatsapp.com/channel/0029VacgxK96hENmSRMRxx1r",
            mediaType: 1,
            renderLargerThumbnail: false
        }
      }
    }, {
      quoted: m
    });

    await Matrix.sendMessage(m.from, {
      audio: { url: 'https://github.com/XdTechPro/KHAN-DATA/raw/refs/heads/main/autovoice/menunew.m4a' },
      mimetype: 'audio/mp4',
      ptt: true
    }, { quoted: m });
  }
};

export default menu;
